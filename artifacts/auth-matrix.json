{
  "_metadata": {
    "generated": "2026-02-09",
    "authProviders": ["Apple Sign In (Supabase)", "Email/Password (Supabase)", "Admin PIN"],
    "sessionStorage": "Hive (mobile), Memory (web)"
  },
  "authMechanisms": {
    "userAuth": {
      "provider": "Supabase",
      "methods": ["Apple Sign In", "Email/Password"],
      "tokenType": "JWT",
      "sessionDuration": "Supabase default (1 hour, auto-refresh)",
      "storage": {
        "mobile": "Secure storage via Supabase Flutter SDK",
        "web": "Memory only (no persistence)"
      }
    },
    "adminAuth": {
      "provider": "Local PIN",
      "method": "4-digit PIN",
      "defaultPin": "4848",
      "sessionDuration": "24 hours",
      "storage": {
        "mobile": "Hive box (admin_box)",
        "web": "Skipped (memory only)"
      },
      "security": {
        "maxAttempts": 5,
        "lockoutDuration": "15 minutes",
        "attemptResetWindow": "5 minutes"
      }
    }
  },
  "scenarios": [
    {
      "id": "ANON_TO_HOME",
      "name": "Anonymous user navigates to home",
      "precondition": "No auth, onboarding not complete",
      "action": "Navigate to /home",
      "expectedResult": "Redirect to /onboarding",
      "platform": "mobile",
      "priority": "critical"
    },
    {
      "id": "ANON_TO_HOME_WEB",
      "name": "Anonymous user navigates to home (web)",
      "precondition": "No auth, fresh session",
      "action": "Navigate to /home",
      "expectedResult": "Show home (web skips storage check)",
      "platform": "web",
      "priority": "critical"
    },
    {
      "id": "ONBOARDING_COMPLETE",
      "name": "User completes onboarding",
      "precondition": "User on /onboarding",
      "action": "Complete onboarding form",
      "expectedResult": "Navigate to /home, onboardingComplete=true",
      "platform": "all",
      "priority": "critical"
    },
    {
      "id": "APPLE_SIGNIN_MOBILE",
      "name": "Apple Sign In on mobile",
      "precondition": "User on premium screen",
      "action": "Tap 'Continue with Apple'",
      "expectedResult": "Native Apple dialog, Supabase session created",
      "platform": "iOS",
      "priority": "high"
    },
    {
      "id": "APPLE_SIGNIN_WEB",
      "name": "Apple Sign In on web",
      "precondition": "User on premium screen",
      "action": "Click 'Continue with Apple'",
      "expectedResult": "OAuth redirect, session created on return",
      "platform": "web",
      "priority": "high"
    },
    {
      "id": "APPLE_SIGNIN_CANCEL",
      "name": "User cancels Apple Sign In",
      "precondition": "Apple dialog shown",
      "action": "Tap Cancel",
      "expectedResult": "Return null, no error shown",
      "platform": "iOS",
      "priority": "medium"
    },
    {
      "id": "APPLE_SIGNIN_NOT_AVAILABLE",
      "name": "Apple Sign In not available",
      "precondition": "Device doesn't support Apple Sign In",
      "action": "Attempt Apple Sign In",
      "expectedResult": "AppleAuthException(notAvailable)",
      "platform": "Android/older iOS",
      "priority": "medium"
    },
    {
      "id": "EMAIL_SIGNUP",
      "name": "Email signup",
      "precondition": "Supabase configured",
      "action": "Submit email/password",
      "expectedResult": "User created, AuthUserInfo returned",
      "platform": "all",
      "priority": "medium"
    },
    {
      "id": "EMAIL_SIGNIN",
      "name": "Email sign in",
      "precondition": "User exists",
      "action": "Submit email/password",
      "expectedResult": "Session created, AuthUserInfo returned",
      "platform": "all",
      "priority": "medium"
    },
    {
      "id": "EMAIL_SIGNIN_WRONG_PASSWORD",
      "name": "Wrong password",
      "precondition": "User exists",
      "action": "Submit wrong password",
      "expectedResult": "Error: 'Invalid email or password'",
      "platform": "all",
      "priority": "high"
    },
    {
      "id": "EMAIL_SIGNUP_DUPLICATE",
      "name": "Duplicate email signup",
      "precondition": "Email already registered",
      "action": "Submit same email",
      "expectedResult": "Error: 'This email address is already in use'",
      "platform": "all",
      "priority": "medium"
    },
    {
      "id": "PASSWORD_RESET",
      "name": "Password reset",
      "precondition": "User exists",
      "action": "Request password reset",
      "expectedResult": "Reset email sent",
      "platform": "all",
      "priority": "medium"
    },
    {
      "id": "SIGNOUT",
      "name": "Sign out",
      "precondition": "User signed in",
      "action": "Call signOut()",
      "expectedResult": "Session cleared, currentUser=null",
      "platform": "all",
      "priority": "high"
    },
    {
      "id": "DELETE_ACCOUNT",
      "name": "Delete account",
      "precondition": "User signed in",
      "action": "Call deleteAccount()",
      "expectedResult": "User data deleted, signed out",
      "platform": "all",
      "priority": "medium"
    },
    {
      "id": "ADMIN_LOGIN_SUCCESS",
      "name": "Admin login with correct PIN",
      "precondition": "Not authenticated as admin",
      "action": "Navigate to /admin/login, enter 4848",
      "expectedResult": "Redirect to /admin, session valid 24h",
      "platform": "mobile",
      "priority": "high"
    },
    {
      "id": "ADMIN_LOGIN_WRONG_PIN",
      "name": "Admin login with wrong PIN",
      "precondition": "Not authenticated",
      "action": "Enter wrong PIN",
      "expectedResult": "Error shown, attempt counter incremented",
      "platform": "mobile",
      "priority": "high"
    },
    {
      "id": "ADMIN_LOCKOUT",
      "name": "Admin lockout after 5 attempts",
      "precondition": "4 failed attempts",
      "action": "Enter wrong PIN 5th time",
      "expectedResult": "Locked out for 15 minutes",
      "platform": "mobile",
      "priority": "high"
    },
    {
      "id": "ADMIN_PROTECTED_ROUTE",
      "name": "Access admin route without auth",
      "precondition": "Not authenticated as admin",
      "action": "Navigate to /admin",
      "expectedResult": "Redirect to /admin/login",
      "platform": "all",
      "priority": "critical"
    },
    {
      "id": "ADMIN_SESSION_EXPIRE",
      "name": "Admin session expires",
      "precondition": "Authenticated 25 hours ago",
      "action": "Navigate to /admin",
      "expectedResult": "Redirect to /admin/login",
      "platform": "mobile",
      "priority": "medium"
    },
    {
      "id": "BLOCKED_ROUTE_REDIRECT",
      "name": "Access blocked route in review mode",
      "precondition": "appStoreReviewMode=true",
      "action": "Navigate to /horoscope",
      "expectedResult": "Redirect to /insight",
      "platform": "all",
      "priority": "critical"
    },
    {
      "id": "NETWORK_ERROR",
      "name": "Auth with no network",
      "precondition": "No internet connection",
      "action": "Attempt Apple Sign In",
      "expectedResult": "AppleAuthException(networkError)",
      "platform": "all",
      "priority": "high"
    },
    {
      "id": "RATE_LIMIT",
      "name": "Too many auth attempts",
      "precondition": "Many recent requests",
      "action": "Attempt sign in",
      "expectedResult": "Error: 'Too many attempts. Please wait a moment'",
      "platform": "all",
      "priority": "medium"
    }
  ],
  "securityChecklist": {
    "cookies": {
      "secure": "N/A (Flutter uses Supabase SDK, not cookies)",
      "httpOnly": "N/A",
      "sameSite": "N/A",
      "notes": "Supabase handles token storage securely"
    },
    "csrf": {
      "protection": "N/A (no form submissions to backend)",
      "notes": "API calls use JWT Bearer tokens"
    },
    "pinSecurity": {
      "hashing": "Plain comparison (low sensitivity)",
      "storage": "Hive local storage",
      "rateLimit": "5 attempts / 15 min lockout",
      "recommendation": "Consider hashing PIN for production"
    },
    "sessionManagement": {
      "user": "Supabase manages JWT refresh automatically",
      "admin": "24h session with manual expiry check"
    },
    "redirectLoop": {
      "prevention": "Explicit checks for splash/onboarding/admin routes",
      "notes": "Web skips storage check to prevent white screen"
    }
  }
}
