# ╔══════════════════════════════════════════════════════════════════════════════╗
# ║                     CRITICAL UI HARD GATE - CI WORKFLOW                       ║
# ╠══════════════════════════════════════════════════════════════════════════════╣
# ║ This workflow enforces the Critical UI Shield protection system.              ║
# ║                                                                               ║
# ║ RULES:                                                                        ║
# ║   1. ALL critical UI tests MUST pass                                          ║
# ║   2. NO warnings, NO soft failures, NO overrides                              ║
# ║   3. Failure BLOCKS merge to main                                             ║
# ║   4. This protection CANNOT be bypassed                                       ║
# ║                                                                               ║
# ║ Protected elements defined in:                                                ║
# ║   test/critical_ui/critical_ui_registry.dart                                  ║
# ╚══════════════════════════════════════════════════════════════════════════════╝

name: Critical UI Gate

on:
  push:
    branches: [main, develop, 'feature/**', 'fix/**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      run_chaos_tests:
        description: 'Run chaos tests'
        required: false
        default: 'true'
        type: boolean

# Ensure only one instance runs per PR/branch
concurrency:
  group: critical-ui-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: 'stable'

jobs:
  # ═══════════════════════════════════════════════════════════════════════════════
  # JOB 1: Critical UI Regression Tests (REQUIRED)
  # ═══════════════════════════════════════════════════════════════════════════════
  critical-ui-tests:
    name: Critical UI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # This job MUST pass - no continue-on-error

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for bisect if needed

      - name: Create placeholder assets
        run: |
          mkdir -p assets/images
          touch assets/images/.gitkeep
          echo "# CI placeholder" > assets/.env

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Verify critical UI registry exists
        run: |
          if [ ! -f "test/critical_ui/critical_ui_registry.dart" ]; then
            echo "::error::Critical UI registry not found!"
            echo "::error::File required: test/critical_ui/critical_ui_registry.dart"
            exit 1
          fi

      - name: Run Critical UI Regression Tests
        id: critical_tests
        run: |
          echo "╔══════════════════════════════════════════════════════════════════════════════╗"
          echo "║                  RUNNING CRITICAL UI REGRESSION TESTS                        ║"
          echo "╚══════════════════════════════════════════════════════════════════════════════╝"

          flutter test test/critical_ui/critical_ui_regression_test.dart \
            --no-pub \
            --reporter expanded \
            --coverage \
            2>&1 | tee test_output.txt

          # Capture exit code
          TEST_EXIT=${PIPESTATUS[0]}

          # Count failures
          FAILED=$(grep -c "FAILED\|✗" test_output.txt || echo "0")
          PASSED=$(grep -c "✓" test_output.txt || echo "0")

          echo "passed_count=$PASSED" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED" >> $GITHUB_OUTPUT
          echo "exit_code=$TEST_EXIT" >> $GITHUB_OUTPUT

          if [ $TEST_EXIT -ne 0 ]; then
            echo ""
            echo "╔══════════════════════════════════════════════════════════════════════════════╗"
            echo "║  ❌ CRITICAL UI TESTS FAILED - MERGE BLOCKED                                 ║"
            echo "╚══════════════════════════════════════════════════════════════════════════════╝"
            exit 1
          fi

          echo ""
          echo "╔══════════════════════════════════════════════════════════════════════════════╗"
          echo "║  ✅ ALL CRITICAL UI TESTS PASSED                                             ║"
          echo "╚══════════════════════════════════════════════════════════════════════════════╝"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: critical-ui-test-results
          path: |
            test_output.txt
            coverage/lcov.info
          retention-days: 30

  # ═══════════════════════════════════════════════════════════════════════════════
  # JOB 2: Chaos Tests (REQUIRED)
  # ═══════════════════════════════════════════════════════════════════════════════
  chaos-tests:
    name: Chaos Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ github.event.inputs.run_chaos_tests != 'false' }}
    # This job MUST pass - no continue-on-error

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create placeholder assets
        run: |
          mkdir -p assets/images
          touch assets/images/.gitkeep
          echo "# CI placeholder" > assets/.env

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run Chaos Tests
        run: |
          echo "╔══════════════════════════════════════════════════════════════════════════════╗"
          echo "║                      RUNNING CHAOS TESTS                                     ║"
          echo "╚══════════════════════════════════════════════════════════════════════════════╝"

          flutter test test/critical_ui/chaos_test.dart \
            --no-pub \
            --reporter expanded \
            2>&1 | tee chaos_output.txt

          TEST_EXIT=${PIPESTATUS[0]}

          if [ $TEST_EXIT -ne 0 ]; then
            echo ""
            echo "╔══════════════════════════════════════════════════════════════════════════════╗"
            echo "║  ❌ CHAOS TESTS FAILED - APP HAS SILENT FAILURES                            ║"
            echo "╚══════════════════════════════════════════════════════════════════════════════╝"
            exit 1
          fi

          echo ""
          echo "╔══════════════════════════════════════════════════════════════════════════════╗"
          echo "║  ✅ ALL CHAOS TESTS PASSED - NO SILENT FAILURES DETECTED                     ║"
          echo "╚══════════════════════════════════════════════════════════════════════════════╝"

      - name: Upload chaos test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chaos-test-results
          path: chaos_output.txt
          retention-days: 30

  # ═══════════════════════════════════════════════════════════════════════════════
  # JOB 3: Registry Validation (REQUIRED)
  # ═══════════════════════════════════════════════════════════════════════════════
  registry-validation:
    name: Registry Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create placeholder assets
        run: |
          mkdir -p assets/images
          touch assets/images/.gitkeep
          echo "# CI placeholder" > assets/.env

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Validate Critical UI Registry
        run: |
          echo "╔══════════════════════════════════════════════════════════════════════════════╗"
          echo "║                  VALIDATING CRITICAL UI REGISTRY                             ║"
          echo "╚══════════════════════════════════════════════════════════════════════════════╝"

          # Run the registry validation tests
          flutter test test/critical_ui/critical_ui_regression_test.dart \
            --no-pub \
            --name "Registry Validation" \
            2>&1

          echo ""
          echo "✅ Registry validation passed"

  # ═══════════════════════════════════════════════════════════════════════════════
  # JOB 4: i18n Coverage Gate (REQUIRED)
  # ═══════════════════════════════════════════════════════════════════════════════
  i18n-gate:
    name: i18n Coverage Gate
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run i18n Coverage Check (BLOCKING)
        run: |
          echo "╔══════════════════════════════════════════════════════════════════════════════╗"
          echo "║                     i18n COVERAGE CHECK (BLOCKING)                           ║"
          echo "╚══════════════════════════════════════════════════════════════════════════════╝"

          dart run scripts/i18n_coverage_check.dart

          if [ $? -ne 0 ]; then
            echo ""
            echo "❌ i18n coverage < 100% - MERGE BLOCKED"
            exit 1
          fi

          echo ""
          echo "✅ i18n coverage check passed"

      - name: Run Hardcoded String Scanner (ADVISORY)
        run: |
          echo "╔══════════════════════════════════════════════════════════════════════════════╗"
          echo "║                   HARDCODED STRING SCANNER (ADVISORY)                        ║"
          echo "╚══════════════════════════════════════════════════════════════════════════════╝"

          dart run scripts/i18n_hardcoded_scanner.dart || true

          echo ""
          echo "⚠️ Hardcoded string scan complete (advisory only)"

  # ═══════════════════════════════════════════════════════════════════════════════
  # JOB 5: Gate Result (REQUIRED - blocks merge)
  # ═══════════════════════════════════════════════════════════════════════════════
  gate-result:
    name: Critical UI Gate Result
    runs-on: ubuntu-latest
    needs: [critical-ui-tests, chaos-tests, registry-validation, i18n-gate]
    if: always()

    steps:
      - name: Check all jobs passed
        run: |
          echo "╔══════════════════════════════════════════════════════════════════════════════╗"
          echo "║                    CRITICAL UI GATE FINAL RESULT                             ║"
          echo "╠══════════════════════════════════════════════════════════════════════════════╣"
          echo "║                                                                              ║"
          echo "║  Critical UI Tests: ${{ needs.critical-ui-tests.result }}"
          echo "║  Chaos Tests: ${{ needs.chaos-tests.result }}"
          echo "║  Registry Validation: ${{ needs.registry-validation.result }}"
          echo "║  i18n Coverage: ${{ needs.i18n-gate.result }}"
          echo "║                                                                              ║"

          # Check results
          CRITICAL="${{ needs.critical-ui-tests.result }}"
          CHAOS="${{ needs.chaos-tests.result }}"
          REGISTRY="${{ needs.registry-validation.result }}"
          I18N="${{ needs.i18n-gate.result }}"

          # All must pass or be skipped (for optional chaos tests)
          if [ "$CRITICAL" != "success" ]; then
            echo "║  ❌ GATE FAILED: Critical UI tests did not pass                             ║"
            echo "╚══════════════════════════════════════════════════════════════════════════════╝"
            exit 1
          fi

          if [ "$CHAOS" != "success" ] && [ "$CHAOS" != "skipped" ]; then
            echo "║  ❌ GATE FAILED: Chaos tests did not pass                                   ║"
            echo "╚══════════════════════════════════════════════════════════════════════════════╝"
            exit 1
          fi

          if [ "$REGISTRY" != "success" ]; then
            echo "║  ❌ GATE FAILED: Registry validation did not pass                           ║"
            echo "╚══════════════════════════════════════════════════════════════════════════════╝"
            exit 1
          fi

          if [ "$I18N" != "success" ]; then
            echo "║  ❌ GATE FAILED: i18n coverage check did not pass                           ║"
            echo "╚══════════════════════════════════════════════════════════════════════════════╝"
            exit 1
          fi

          echo "║  ✅ GATE PASSED: All critical UI protections verified                        ║"
          echo "║                                                                              ║"
          echo "║  Silent UI regressions are now IMPOSSIBLE.                                   ║"
          echo "║  i18n coverage is now 100% enforced.                                         ║"
          echo "╚══════════════════════════════════════════════════════════════════════════════╝"

  # ═══════════════════════════════════════════════════════════════════════════════
  # JOB 5: Breaking Commit Detection (on failure)
  # ═══════════════════════════════════════════════════════════════════════════════
  find-breaking-commit:
    name: Find Breaking Commit
    runs-on: ubuntu-latest
    needs: [critical-ui-tests]
    if: failure()
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for bisect

      - name: Create placeholder assets
        run: |
          mkdir -p assets/images
          touch assets/images/.gitkeep
          echo "# CI placeholder" > assets/.env

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Find breaking commit
        run: |
          echo "╔══════════════════════════════════════════════════════════════════════════════╗"
          echo "║                    SEARCHING FOR BREAKING COMMIT                             ║"
          echo "╚══════════════════════════════════════════════════════════════════════════════╝"

          # Make script executable
          chmod +x scripts/find_breaking_commit.sh

          # Run with last 20 commits as range
          GOOD_COMMIT=$(git rev-parse HEAD~20 2>/dev/null || git rev-list --max-parents=0 HEAD)

          echo "Searching between $GOOD_COMMIT and HEAD..."

          # Run the script (it will output the breaking commit)
          ./scripts/find_breaking_commit.sh --good "$GOOD_COMMIT" --bad HEAD || true

      - name: Comment on PR with breaking commit
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let body = `## ❌ Critical UI Gate Failed\n\n`;
            body += `Critical UI tests failed. A breaking commit may have been introduced.\n\n`;
            body += `Please check the "Find Breaking Commit" job output for details.\n\n`;
            body += `### Quick Fix Steps:\n`;
            body += `1. Review the failing tests in the "Critical UI Tests" job\n`;
            body += `2. Check the breaking commit identification\n`;
            body += `3. Fix the identified issues\n`;
            body += `4. Push the fix\n\n`;
            body += `⚠️ **This PR cannot be merged until all critical UI tests pass.**`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
