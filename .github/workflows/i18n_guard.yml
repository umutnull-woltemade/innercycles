name: i18n Mixed Language Guard

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  check-mixed-language:
    name: Check for Mixed Language Violations
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded Turkish in Dart files
        run: |
          echo "=== Scanning for hardcoded Turkish strings in lib/ ==="

          # Turkish-specific patterns that should never be hardcoded
          PATTERNS=(
            "Merhaba"
            "Hoşgeldin"
            "Hoşgeldiniz"
            "Burç yorumu"
            "Günlük yorum"
            "Haftalık yorum"
            "Aylık yorum"
            "Giriş yap"
            "Çıkış yap"
            "Kaydet"
            "İptal"
            "Devam et"
            "Lütfen bekleyin"
          )

          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            # Search in Dart files, exclude comments and l10n references
            MATCHES=$(grep -rn "$pattern" lib/ --include="*.dart" 2>/dev/null | \
                      grep -v "// " | \
                      grep -v "/// " | \
                      grep -v "l10n" | \
                      grep -v "L10nService" | \
                      grep -v "_tr" | \
                      grep -v "nameTr" | \
                      grep -v "AppLanguage.tr" | \
                      grep -v "localization_service.dart" | \
                      grep -v "dream_content" | \
                      grep -v "kadim_not_card" | \
                      grep -v "seo_meta_service" || true)
            if [ -n "$MATCHES" ]; then
              echo "FOUND HARDCODED TURKISH: '$pattern'"
              echo "$MATCHES"
              echo "---"
              FOUND=$((FOUND + 1))
            fi
          done

          if [ $FOUND -gt 0 ]; then
            echo ""
            echo "ERROR: Found $FOUND potential hardcoded Turkish strings."
            echo "Please use L10nService.get() for all user-facing strings."
            exit 1
          fi

          echo "OK: No hardcoded Turkish strings found in lib/"

      - name: Verify EN build has no Turkish markers
        run: |
          echo "=== Checking en.json for Turkish content leaks ==="

          # Check that EN locale JSON has no Turkish-specific content
          if grep -E "Burç|günlük|haftalık|aylık|yorum|giriş|çıkış" assets/l10n/en.json 2>/dev/null; then
            echo "WARNING: Potential Turkish content found in en.json"
            echo "Please review and ensure all values are in English."
            # Advisory only, don't fail
          else
            echo "OK: en.json appears to be clean"
          fi

      - name: Check translation key parity
        run: |
          echo "=== Checking translation key parity ==="

          EN_KEYS=$(grep -o '"[^"]*":' assets/l10n/en.json 2>/dev/null | wc -l || echo "0")
          TR_KEYS=$(grep -o '"[^"]*":' assets/l10n/tr.json 2>/dev/null | wc -l || echo "0")
          DE_KEYS=$(grep -o '"[^"]*":' assets/l10n/de.json 2>/dev/null | wc -l || echo "0")
          FR_KEYS=$(grep -o '"[^"]*":' assets/l10n/fr.json 2>/dev/null | wc -l || echo "0")

          echo "EN: $EN_KEYS keys (baseline)"
          echo "TR: $TR_KEYS keys"
          echo "DE: $DE_KEYS keys"
          echo "FR: $FR_KEYS keys"

          # Check if any language is significantly behind (more than 10% difference)
          if [ "$TR_KEYS" -lt $((EN_KEYS * 90 / 100)) ]; then
            echo "WARNING: TR is more than 10% behind EN"
          fi
          if [ "$DE_KEYS" -lt $((EN_KEYS * 90 / 100)) ]; then
            echo "WARNING: DE is more than 10% behind EN"
          fi
          if [ "$FR_KEYS" -lt $((EN_KEYS * 90 / 100)) ]; then
            echo "WARNING: FR is more than 10% behind EN"
          fi

          echo "Translation parity check complete."

  summary:
    name: i18n Guard Summary
    runs-on: ubuntu-latest
    needs: check-mixed-language
    if: always()

    steps:
      - name: Report status
        run: |
          if [ "${{ needs.check-mixed-language.result }}" == "success" ]; then
            echo "i18n Guard: PASSED"
            echo "No mixed language violations detected."
          else
            echo "i18n Guard: FAILED"
            echo "Please fix hardcoded strings before merging."
            exit 1
          fi
