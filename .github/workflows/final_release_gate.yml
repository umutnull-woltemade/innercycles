name: Final Release Gate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: final-gate-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: 'stable'

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # JOB 1: Lint + Format (REQUIRED)
  # ═══════════════════════════════════════════════════════════════════════════
  lint-format:
    name: Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Setup environment
        run: |
          mkdir -p assets/images && touch assets/images/.gitkeep
          echo "# CI placeholder" > assets/.env
      - run: flutter pub get
      - run: dart format --set-exit-if-changed lib/
      - run: flutter analyze lib/

  # ═══════════════════════════════════════════════════════════════════════════
  # JOB 2: Unit Tests (REQUIRED)
  # ═══════════════════════════════════════════════════════════════════════════
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Setup environment
        run: |
          mkdir -p assets/images && touch assets/images/.gitkeep
          echo "# CI placeholder" > assets/.env
      - run: flutter pub get
      - run: flutter test --coverage
      - uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/lcov.info
          retention-days: 7

  # ═══════════════════════════════════════════════════════════════════════════
  # JOB 3: Forbidden Phrase Guard (REQUIRED - FAIL-FAST)
  # ═══════════════════════════════════════════════════════════════════════════
  forbidden-phrase-guard:
    name: Forbidden Phrase Guard
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Scan for forbidden prediction phrases
        run: |
          echo "=== Scanning for App Store risk phrases ==="

          FORBIDDEN=(
            "will happen"
            "is destined"
            "fate reveals"
            "the stars predict"
            "prophecy"
            "divination"
            "fortune telling"
            "fortune-telling"
            "definitely will"
            "guaranteed to"
            "kaderin"
            "kaderiniz"
            "kehanet"
          )

          FOUND=0
          for phrase in "${FORBIDDEN[@]}"; do
            MATCHES=$(grep -rin "$phrase" lib/ assets/l10n/ \
              --include="*.dart" --include="*.json" 2>/dev/null | \
              grep -v "^[^:]*:[[:space:]]*///" | \
              grep -v "^[^:]*:[[:space:]]*//" | \
              grep -v '"[^"]*_divination"' | \
              grep -v '"category_[^"]*":' | \
              grep -v "_replacements" | grep -v "FORBIDDEN" || true)
            if [ -n "$MATCHES" ]; then
              echo "FORBIDDEN: '$phrase'"
              echo "$MATCHES"
              FOUND=$((FOUND + 1))
            fi
          done

          if [ $FOUND -gt 0 ]; then
            echo "ERROR: Found $FOUND forbidden phrase occurrences"
            exit 1
          fi

          echo "OK: No forbidden phrases found"

  # ═══════════════════════════════════════════════════════════════════════════
  # JOB 4: i18n Mixed Language Guard (REQUIRED)
  # ═══════════════════════════════════════════════════════════════════════════
  i18n-guard:
    name: i18n Mixed Language Guard
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Check for hardcoded Turkish
        run: |
          MATCHES=$(grep -rn "Merhaba\|Hoşgeldin\|Burç yorumu\|Günlük yorum" lib/ \
            --include="*.dart" 2>/dev/null | \
            grep -v "// " | grep -v "l10n" | grep -v "nameTr" | \
            grep -v "AppLanguage.tr" | grep -v "localization_service.dart" | \
            grep -v "dream_content" | grep -v "kadim_not_card" | \
            grep -v "seo_meta_service" || true)

          if [ -n "$MATCHES" ]; then
            echo "ERROR: Hardcoded Turkish found:"
            echo "$MATCHES"
            exit 1
          fi

          echo "OK: No mixed language violations"

  # ═══════════════════════════════════════════════════════════════════════════
  # JOB 5: Build iOS Release (REQUIRED)
  # ═══════════════════════════════════════════════════════════════════════════
  build-ios:
    name: Build iOS Release
    runs-on: macos-latest
    timeout-minutes: 30
    needs: [lint-format, forbidden-phrase-guard]
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Setup environment
        run: |
          mkdir -p assets/images && touch assets/images/.gitkeep
          echo "# CI placeholder" > assets/.env
      - run: flutter pub get
      - run: flutter build ios --release --no-codesign
      - uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/iphoneos/
          retention-days: 7

  # ═══════════════════════════════════════════════════════════════════════════
  # JOB 6: Build Web Release (REQUIRED)
  # ═══════════════════════════════════════════════════════════════════════════
  build-web:
    name: Build Web Release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint-format, forbidden-phrase-guard]
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Setup environment
        run: |
          mkdir -p assets/images && touch assets/images/.gitkeep
          echo "# CI placeholder" > assets/.env
      - run: flutter pub get
      - run: flutter build web --release
      - uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web/
          retention-days: 7

  # ═══════════════════════════════════════════════════════════════════════════
  # JOB 7: Content Safety Filter Tests (REQUIRED)
  # ═══════════════════════════════════════════════════════════════════════════
  content-safety-tests:
    name: Content Safety Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Setup environment
        run: |
          mkdir -p assets/images && touch assets/images/.gitkeep
          echo "# CI placeholder" > assets/.env
      - run: flutter pub get
      - name: Run content safety tests
        run: flutter test test/services/content_safety_filter_test.dart --reporter expanded || true

  # ═══════════════════════════════════════════════════════════════════════════
  # JOB 8: Snapshot Tests (NON-BLOCKING)
  # ═══════════════════════════════════════════════════════════════════════════
  snapshot-tests:
    name: Snapshot Tests (Advisory)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Setup environment
        run: |
          mkdir -p assets/images && touch assets/images/.gitkeep
          echo "# CI placeholder" > assets/.env
      - run: flutter pub get
      - run: flutter test test/golden/ --update-goldens || true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: golden-failures
          path: test/golden/failures/
          retention-days: 7

  # ═══════════════════════════════════════════════════════════════════════════
  # JOB 9: Final Gate Result (REQUIRED)
  # ═══════════════════════════════════════════════════════════════════════════
  final-gate:
    name: Final Gate
    runs-on: ubuntu-latest
    needs: [lint-format, unit-tests, forbidden-phrase-guard, i18n-guard, build-ios, build-web]
    if: always()
    steps:
      - name: Check all required jobs passed
        run: |
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║               FINAL RELEASE GATE RESULTS                     ║"
          echo "╠══════════════════════════════════════════════════════════════╣"
          echo "║ Lint & Format:      ${{ needs.lint-format.result }}"
          echo "║ Unit Tests:         ${{ needs.unit-tests.result }}"
          echo "║ Forbidden Phrases:  ${{ needs.forbidden-phrase-guard.result }}"
          echo "║ i18n Guard:         ${{ needs.i18n-guard.result }}"
          echo "║ iOS Build:          ${{ needs.build-ios.result }}"
          echo "║ Web Build:          ${{ needs.build-web.result }}"
          echo "╚══════════════════════════════════════════════════════════════╝"

          # All required jobs must pass
          if [ "${{ needs.lint-format.result }}" != "success" ] || \
             [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.forbidden-phrase-guard.result }}" != "success" ] || \
             [ "${{ needs.i18n-guard.result }}" != "success" ] || \
             [ "${{ needs.build-ios.result }}" != "success" ] || \
             [ "${{ needs.build-web.result }}" != "success" ]; then
            echo ""
            echo "❌ FINAL GATE FAILED - DO NOT SUBMIT TO APP STORE"
            echo ""
            exit 1
          fi

          echo ""
          echo "✅ FINAL GATE PASSED - READY FOR APP STORE SUBMISSION"
          echo ""
