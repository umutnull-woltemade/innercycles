# ============================================================================
# release_upload.yml
# Tag-based release pipeline: smoke → build → upload → release → notify
#
# Trigger: push tag matching v* (e.g. v1.0.0, v2.3.1)
#
# Secrets naming convention (repo-aware):
#   {REPO_KEY}_SLACK_WEBHOOK_URL
#   {REPO_KEY}_PLAY_SERVICE_ACCOUNT_JSON
#   {REPO_KEY}_ANDROID_PACKAGE_NAME
#   {REPO_KEY}_APP_STORE_CONNECT_KEY_ID
#   {REPO_KEY}_APP_STORE_CONNECT_ISSUER_ID
#   {REPO_KEY}_APP_STORE_CONNECT_KEY_P8
#   {REPO_KEY}_IOS_BUNDLE_ID
#   {REPO_KEY}_TEAM_ID
#   {REPO_KEY}_MATCH_PASSWORD
#   {REPO_KEY}_MATCH_GIT_URL
#   {REPO_KEY}_KEYCHAIN_PASSWORD
#   {REPO_KEY}_ANDROID_KEYSTORE_BASE64
#   {REPO_KEY}_ANDROID_KEY_ALIAS
#   {REPO_KEY}_ANDROID_KEY_PASSWORD
#   {REPO_KEY}_ANDROID_STORE_PASSWORD
# ============================================================================

name: Release Upload

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  FLUTTER_VERSION: '3.27.4'
  JAVA_VERSION: '17'
  RUBY_VERSION: '3.2'

jobs:
  # ========================================================================
  # STEP 0 — Derive repo key & extract version
  # ========================================================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      repo_key: ${{ steps.key.outputs.repo_key }}
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive REPO_KEY
        id: key
        run: |
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          REPO_KEY="$(echo "${REPO_NAME}" | tr '[:lower:]' '[:upper:]' | sed 's/[^A-Z0-9]/_/g')"
          echo "repo_key=${REPO_KEY}" >> "$GITHUB_OUTPUT"
          echo "Derived REPO_KEY: ${REPO_KEY}"

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          BUILD_NUMBER="${GITHUB_RUN_NUMBER}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "build_number=${BUILD_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "Version: ${VERSION}+${BUILD_NUMBER}"

  # ========================================================================
  # STEP 1 — Smoke tests
  # ========================================================================
  smoke-tests:
    needs: prepare
    runs-on: ubuntu-latest
    env:
      REPO_KEY: ${{ needs.prepare.outputs.repo_key }}
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze
        run: flutter analyze --no-fatal-infos

      - name: Run unit & widget tests
        run: flutter test --coverage --reporter=expanded

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            coverage/
            test-results/

      - name: Notify Slack on test failure
        if: failure()
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ secrets[format('{0}_SLACK_WEBHOOK_URL', env.REPO_KEY)] }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "❌ *Smoke tests failed* for `${{ github.ref_name }}`\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
            }

  # ========================================================================
  # STEP 2 — Generate release notes
  # ========================================================================
  release-notes:
    needs: [prepare, smoke-tests]
    runs-on: ubuntu-latest
    outputs:
      release_body: ${{ steps.notes.outputs.release_body }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: notes
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          chmod +x scripts/generate_release_notes.sh
          bash scripts/generate_release_notes.sh

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: |
            release_notes.md
            release_notes_short.txt

  # ========================================================================
  # STEP 3 — Build & Upload Android (AAB → Play Console Internal Testing)
  # ========================================================================
  android:
    needs: [prepare, smoke-tests, release-notes]
    runs-on: ubuntu-latest
    env:
      REPO_KEY: ${{ needs.prepare.outputs.repo_key }}
      VERSION: ${{ needs.prepare.outputs.version }}
      BUILD_NUMBER: ${{ needs.prepare.outputs.build_number }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: android

      - name: Install dependencies
        run: flutter pub get

      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes

      - name: Decode keystore
        run: |
          echo "${{ secrets[format('{0}_ANDROID_KEYSTORE_BASE64', env.REPO_KEY)] }}" \
            | base64 --decode > android/app/release-keystore.jks

      - name: Build AAB
        env:
          KEY_ALIAS: ${{ secrets[format('{0}_ANDROID_KEY_ALIAS', env.REPO_KEY)] }}
          KEY_PASSWORD: ${{ secrets[format('{0}_ANDROID_KEY_PASSWORD', env.REPO_KEY)] }}
          STORE_PASSWORD: ${{ secrets[format('{0}_ANDROID_STORE_PASSWORD', env.REPO_KEY)] }}
        run: |
          flutter build appbundle \
            --release \
            --build-name="${VERSION}" \
            --build-number="${BUILD_NUMBER}" \
            --dart-define=FLAVOR=production

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/*.aab

      - name: Write Play service account JSON
        run: |
          echo '${{ secrets[format('{0}_PLAY_SERVICE_ACCOUNT_JSON', env.REPO_KEY)] }}' \
            > android/fastlane/play-service-account.json

      - name: Upload to Play Console (Internal Testing)
        working-directory: android
        run: |
          bundle exec fastlane internal \
            version_name:"${VERSION}" \
            version_code:"${BUILD_NUMBER}"

      - name: Cleanup secrets
        if: always()
        run: |
          rm -f android/app/release-keystore.jks
          rm -f android/fastlane/play-service-account.json

  # ========================================================================
  # STEP 4 — Build & Upload iOS (IPA → TestFlight)
  # ========================================================================
  ios:
    needs: [prepare, smoke-tests, release-notes]
    runs-on: macos-latest
    env:
      REPO_KEY: ${{ needs.prepare.outputs.repo_key }}
      VERSION: ${{ needs.prepare.outputs.version }}
      BUILD_NUMBER: ${{ needs.prepare.outputs.build_number }}
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
          working-directory: ios

      - name: Install dependencies
        run: flutter pub get

      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes

      - name: Write App Store Connect API key
        run: |
          mkdir -p ios/fastlane
          echo '${{ secrets[format('{0}_APP_STORE_CONNECT_KEY_P8', env.REPO_KEY)] }}' \
            > ios/fastlane/AuthKey.p8

      - name: Build IPA
        run: |
          flutter build ipa \
            --release \
            --build-name="${VERSION}" \
            --build-number="${BUILD_NUMBER}" \
            --dart-define=FLAVOR=production \
            --export-options-plist=ios/ExportOptions.plist

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/ios/ipa/*.ipa

      - name: Upload to TestFlight
        working-directory: ios
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets[format('{0}_APP_STORE_CONNECT_KEY_ID', env.REPO_KEY)] }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets[format('{0}_APP_STORE_CONNECT_ISSUER_ID', env.REPO_KEY)] }}
          MATCH_PASSWORD: ${{ secrets[format('{0}_MATCH_PASSWORD', env.REPO_KEY)] }}
          MATCH_GIT_URL: ${{ secrets[format('{0}_MATCH_GIT_URL', env.REPO_KEY)] }}
          KEYCHAIN_PASSWORD: ${{ secrets[format('{0}_KEYCHAIN_PASSWORD', env.REPO_KEY)] }}
          TEAM_ID: ${{ secrets[format('{0}_TEAM_ID', env.REPO_KEY)] }}
        run: |
          CHANGELOG="$(cat ../release_notes_short.txt 2>/dev/null || echo 'Bug fixes and improvements.')"
          bundle exec fastlane beta \
            version:"${VERSION}" \
            build_number:"${BUILD_NUMBER}" \
            changelog:"${CHANGELOG}"

      - name: Cleanup secrets
        if: always()
        run: rm -f ios/fastlane/AuthKey.p8

  # ========================================================================
  # STEP 5 — Create GitHub Release
  # ========================================================================
  github-release:
    needs: [prepare, release-notes, android, ios]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body_path: release-notes/release_notes.md
          draft: false
          prerelease: false
          files: |
            android-aab/*.aab
            ios-ipa/*.ipa

  # ========================================================================
  # STEP 6 — Slack notification (final)
  # ========================================================================
  notify:
    needs: [prepare, github-release]
    if: always()
    runs-on: ubuntu-latest
    env:
      REPO_KEY: ${{ needs.prepare.outputs.repo_key }}
    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.github-release.result }}" == "success" ]]; then
            echo "emoji=✅" >> "$GITHUB_OUTPUT"
            echo "text=Release *${{ github.ref_name }}* shipped successfully" >> "$GITHUB_OUTPUT"
            echo "color=#36a64f" >> "$GITHUB_OUTPUT"
          else
            echo "emoji=❌" >> "$GITHUB_OUTPUT"
            echo "text=Release *${{ github.ref_name }}* failed" >> "$GITHUB_OUTPUT"
            echo "color=#dc3545" >> "$GITHUB_OUTPUT"
          fi

      - name: Notify Slack
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ secrets[format('{0}_SLACK_WEBHOOK_URL', env.REPO_KEY)] }}
          webhook-type: incoming-webhook
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.color }}",
                  "blocks": [
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "${{ steps.status.outputs.emoji }} ${{ steps.status.outputs.text }}\n\n*Version:* `${{ needs.prepare.outputs.version }}+${{ needs.prepare.outputs.build_number }}`\n*Tag:* `${{ github.ref_name }}`\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Pipeline> · <${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}|View Release>"
                      }
                    }
                  ]
                }
              ]
            }
