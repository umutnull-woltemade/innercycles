name: Content Pipeline

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'lib/data/content/**'
      - 'tools/**'
  push:
    branches: [main, develop]
    paths:
      - 'lib/data/content/**'
      - 'tools/**'
  workflow_dispatch:

jobs:
  # Stage 1: Static Analysis
  analyze:
    name: Flutter Analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
      - run: flutter pub get
      - run: flutter analyze lib/data/content/

  # Stage 2: Prediction Filter
  prediction-filter:
    name: Prediction Filter (4.3b)
    runs-on: ubuntu-latest
    needs: analyze
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
      - run: flutter pub get
      - run: dart run tools/prediction_filter.dart lib/data/content/

  # Stage 3: Compliance Scanner
  compliance-scan:
    name: Compliance Scanner
    runs-on: ubuntu-latest
    needs: analyze
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
      - run: flutter pub get
      - run: dart run tools/compliance_scanner.dart lib/data/content/

  # Stage 4: Content Validator
  content-quality:
    name: Content Quality
    runs-on: ubuntu-latest
    needs: analyze
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
      - run: flutter pub get
      - run: dart run tools/content_validator.dart lib/data/content/

  # Stage 5: Duplicate Detector
  duplicate-check:
    name: Duplicate Detector
    runs-on: ubuntu-latest
    needs: analyze
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
      - run: flutter pub get
      - run: dart run tools/duplicate_detector.dart lib/data/content/

  # Stage 6: iOS Build Verification
  ios-build:
    name: iOS Build Check
    runs-on: macos-latest
    needs: [prediction-filter, compliance-scan, content-quality, duplicate-check]
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
      - run: flutter pub get
      - run: flutter build ios --no-codesign

  # Summary
  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [analyze, prediction-filter, compliance-scan, content-quality, duplicate-check, ios-build]
    if: always()
    steps:
      - name: Report
        run: |
          echo "╔══════════════════════════════════════════════════════╗"
          echo "║       Content Pipeline — Results                    ║"
          echo "╚══════════════════════════════════════════════════════╝"
          echo ""
          echo "Analyze:      ${{ needs.analyze.result }}"
          echo "Prediction:   ${{ needs.prediction-filter.result }}"
          echo "Compliance:   ${{ needs.compliance-scan.result }}"
          echo "Quality:      ${{ needs.content-quality.result }}"
          echo "Duplicates:   ${{ needs.duplicate-check.result }}"
          echo "iOS Build:    ${{ needs.ios-build.result }}"
          echo ""

          if [ "${{ needs.prediction-filter.result }}" != "success" ] || \
             [ "${{ needs.compliance-scan.result }}" != "success" ]; then
            echo "❌ BLOCKED — Fix compliance issues before merge."
            exit 1
          fi

          echo "✅ All gates passed."
