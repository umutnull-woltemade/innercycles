name: Agents Parallel

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_appstore:
        description: 'Run App Store validation (requires macOS runner)'
        type: boolean
        default: false

concurrency:
  group: agents-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  # ============================================================================
  # Job 1: agent:i18n - Language Purity Tests
  # Maps 1:1 to VS Code task "agent:i18n"
  # ============================================================================
  agent-i18n:
    name: agent:i18n
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run i18n tests (with retry)
        id: test
        run: |
          MAX_ATTEMPTS=3
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

            if flutter test test/l10n/language_purity_test.dart; then
              echo ""
              echo "✅ agent:i18n passed"
              exit 0
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              SLEEP_TIME=$((ATTEMPT * 5))
              echo "Retrying in ${SLEEP_TIME}s..."
              sleep $SLEEP_TIME
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          echo ""
          echo "❌ agent:i18n failed after $MAX_ATTEMPTS attempts"
          exit 1

      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: i18n-logs-${{ github.run_id }}
          path: |
            flutter_*.log
            test-results/
          retention-days: 7

  # ============================================================================
  # Job 2: agent:snapshot - Critical UI Regression Tests
  # Maps 1:1 to VS Code task "agent:snapshot"
  # ============================================================================
  agent-snapshot:
    name: agent:snapshot
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run snapshot tests (with retry)
        id: test
        run: |
          MAX_ATTEMPTS=3
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

            if flutter test test/critical_ui/critical_ui_regression_test.dart; then
              echo ""
              echo "✅ agent:snapshot passed"
              exit 0
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              SLEEP_TIME=$((ATTEMPT * 5))
              echo "Retrying in ${SLEEP_TIME}s..."
              sleep $SLEEP_TIME
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          echo ""
          echo "❌ agent:snapshot failed after $MAX_ATTEMPTS attempts"
          exit 1

      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-logs-${{ github.run_id }}
          path: |
            flutter_*.log
            test-results/
          retention-days: 7

  # ============================================================================
  # Job 3: agent:chaos - Chaos/Fault Injection Tests
  # Maps 1:1 to VS Code task "agent:chaos"
  # ============================================================================
  agent-chaos:
    name: agent:chaos
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run chaos tests (with retry)
        id: test
        run: |
          MAX_ATTEMPTS=2
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

            if flutter test test/critical_ui/chaos_testing.dart; then
              echo ""
              echo "✅ agent:chaos passed"
              exit 0
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              SLEEP_TIME=$((ATTEMPT * 5))
              echo "Retrying in ${SLEEP_TIME}s..."
              sleep $SLEEP_TIME
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          echo ""
          echo "❌ agent:chaos failed after $MAX_ATTEMPTS attempts"
          exit 1

      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: chaos-logs-${{ github.run_id }}
          path: |
            flutter_*.log
            test-results/
          retention-days: 7

  # ============================================================================
  # Job 4: agent:appstore - iOS Deployment Validation (Manual Only)
  # Maps 1:1 to VS Code task "agent:appstore"
  # Requires macOS runner and manual trigger
  # ============================================================================
  agent-appstore:
    name: agent:appstore
    runs-on: macos-latest
    timeout-minutes: 30
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_appstore == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run App Store validation
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "agent:appstore - iOS Deployment Validation"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          chmod +x ./auto_deploy.sh
          ./auto_deploy.sh

      - name: Upload deployment report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: appstore-report-${{ github.run_id }}
          path: |
            DEPLOYMENT_REPORT.txt
            ios/build/*.log
          retention-days: 14

  # ============================================================================
  # Orchestrator: Aggregate Results
  # Waits for all agents and reports final status
  # ============================================================================
  agents-result:
    name: All Agents
    runs-on: ubuntu-latest
    needs: [agent-i18n, agent-snapshot, agent-chaos]
    if: always()
    steps:
      - name: Check all agent results
        run: |
          echo ""
          echo "╔══════════════════════════════════════════════════════════════════╗"
          echo "║              AGENTS PARALLEL - FINAL RESULTS                     ║"
          echo "╠══════════════════════════════════════════════════════════════════╣"
          echo "║ agent:i18n     : ${{ needs.agent-i18n.result }}"
          echo "║ agent:snapshot : ${{ needs.agent-snapshot.result }}"
          echo "║ agent:chaos    : ${{ needs.agent-chaos.result }}"
          echo "╚══════════════════════════════════════════════════════════════════╝"
          echo ""

          FAILED=0

          if [[ "${{ needs.agent-i18n.result }}" != "success" ]]; then
            echo "❌ agent:i18n did not succeed"
            FAILED=1
          fi

          if [[ "${{ needs.agent-snapshot.result }}" != "success" ]]; then
            echo "❌ agent:snapshot did not succeed"
            FAILED=1
          fi

          if [[ "${{ needs.agent-chaos.result }}" != "success" ]]; then
            echo "❌ agent:chaos did not succeed"
            FAILED=1
          fi

          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "═══════════════════════════════════════════════════════════════════"
            echo "RESULT: One or more agents failed"
            echo "═══════════════════════════════════════════════════════════════════"
            exit 1
          fi

          echo ""
          echo "═══════════════════════════════════════════════════════════════════"
          echo "✅ All agents passed successfully"
          echo "═══════════════════════════════════════════════════════════════════"
