name: Forbidden Phrase Guard

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  check-forbidden-phrases:
    name: Check for App Store Risk Phrases
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check UI strings for forbidden phrases
        run: |
          echo "Scanning for App Store risk phrases..."

          # Define forbidden phrases (fortune-telling, predictions, astrology-forward)
          FORBIDDEN_PATTERNS=(
            # Prediction language (English)
            "will happen"
            "is destined"
            "fate reveals"
            "the stars predict"
            "your future"
            "prophecy"
            "divination"
            "fortune telling"
            "fortune-telling"

            # Prediction language (Turkish)
            "kaderin"
            "kaderiniz"
            "kehanet"
            "gelecekte olacak"
            "olacaktır"

            # Astrology-forward (English)
            "horoscope reading"
            "zodiac reading"
            "planetary influence"
            "birth chart reading"
            "the cards reveal"
            "according to the stars"
            "the planets indicate"

            # Certainty language (English)
            "definitely will"
            "certainly going to"
            "guaranteed to"
            "without doubt"
            "absolutely will"

            # Certainty language (Turkish)
            "kesinlikle olacak"
            "mutlaka gerçekleşecek"
          )

          # Files to scan
          SCAN_PATHS=(
            "lib/features/insight/"
            "assets/l10n/"
            "scripts/insight_seeds_*.json"
          )

          FOUND_ISSUES=0

          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            for path in "${SCAN_PATHS[@]}"; do
              if [ -d "$path" ] || [ -f "$path" ]; then
                MATCHES=$(grep -ri "$pattern" $path 2>/dev/null || true)
                if [ -n "$MATCHES" ]; then
                  echo "FORBIDDEN PHRASE FOUND: '$pattern'"
                  echo "$MATCHES"
                  echo "---"
                  FOUND_ISSUES=$((FOUND_ISSUES + 1))
                fi
              fi
            done
          done

          if [ $FOUND_ISSUES -gt 0 ]; then
            echo ""
            echo "ERROR: Found $FOUND_ISSUES forbidden phrase occurrences."
            echo "These phrases violate App Store guidelines 4.3(b)."
            echo "Please remove all prediction, fortune-telling, and astrology-forward language."
            exit 1
          fi

          echo "All clear! No forbidden phrases found."

      - name: Check AI prompts for safe language
        run: |
          echo "Scanning AI service files for safe language patterns..."

          # Check that AI prompts include safety guardrails
          AI_FILES=(
            "lib/data/services/ai_content_service.dart"
            "lib/features/insight/services/insight_response_service.dart"
          )

          SAFE_PATTERNS=(
            "might represent"
            "could symbolize"
            "may find"
            "often surfaces"
            "many people experience"
          )

          for file in "${AI_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "Checking $file for reflective language..."
              SAFE_COUNT=0
              for pattern in "${SAFE_PATTERNS[@]}"; do
                if grep -qi "$pattern" "$file"; then
                  SAFE_COUNT=$((SAFE_COUNT + 1))
                fi
              done

              if [ $SAFE_COUNT -lt 2 ]; then
                echo "WARNING: $file may not have enough reflective language patterns."
                echo "Consider adding more 'might', 'could', 'may' qualifiers."
              else
                echo "OK: $file contains appropriate reflective language."
              fi
            fi
          done

          echo "AI prompt scan complete."

      - name: Validate Insight response validation exists
        run: |
          echo "Checking for APEX validation in AI service..."

          if grep -q "_validateInsightResponse" lib/data/services/ai_content_service.dart; then
            echo "OK: Insight response validation found."
          else
            echo "ERROR: _validateInsightResponse method not found!"
            echo "AI responses must be validated for App Store compliance."
            exit 1
          fi

          echo "Validation check complete."

  summary:
    name: Guard Summary
    runs-on: ubuntu-latest
    needs: check-forbidden-phrases
    if: always()

    steps:
      - name: Report status
        run: |
          if [ "${{ needs.check-forbidden-phrases.result }}" == "success" ]; then
            echo "Forbidden Phrase Guard: PASSED"
            echo "All content is Apple-safe."
          else
            echo "Forbidden Phrase Guard: FAILED"
            echo "Please fix the issues above before merging."
            exit 1
          fi
