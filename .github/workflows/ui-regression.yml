name: UI Regression Guard

on:
  pull_request:
    paths:
      - 'lib/core/theme/**'
      - 'lib/shared/widgets/**'
      - 'lib/features/**/presentation/**'
      - 'assets/design_tokens.json'

jobs:
  token-drift:
    name: Token Drift Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check design token changes
        run: |
          if git diff HEAD~1 --name-only | grep -q "design_tokens.json"; then
            echo "⚠️ Design tokens changed — verifying Dart sync..."
            # Compare token JSON hash with generated Dart constants
            TOKEN_HASH=$(sha256sum assets/design_tokens.json | cut -d' ' -f1)
            echo "Token hash: $TOKEN_HASH"
            # Check if cosmic_palette.dart was also updated
            if ! git diff HEAD~1 --name-only | grep -q "cosmic_palette.dart\|glass_tokens.dart"; then
              echo "❌ DRIFT DETECTED: tokens changed but Dart constants not updated"
              exit 1
            fi
            echo "✅ Token and Dart files both updated"
          else
            echo "✅ No token changes"
          fi

  golden-images:
    name: Golden Image Comparison
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.x'
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Run golden tests
        run: |
          flutter test test/golden/ \
            --tags=golden \
            --reporter=expanded \
            2>&1 || {
              echo "❌ Golden image mismatch detected"
              echo "Run 'flutter test test/golden/ --update-goldens' locally to update"
              exit 1
            }

      - name: Upload failure diffs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: golden-failures
          path: test/golden/failures/
          retention-days: 7

  theme-audit:
    name: Theme Consistency Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for hardcoded colors
        run: |
          # Scan for Color(0xFF...) outside theme files
          VIOLATIONS=$(grep -rn "Color(0xFF" lib/features/ lib/shared/widgets/ \
            --include="*.dart" \
            | grep -v "// theme-exempt" \
            | grep -v "_test.dart" \
            || true)

          if [ -n "$VIOLATIONS" ]; then
            echo "⚠️ Hardcoded colors found outside theme system:"
            echo "$VIOLATIONS"
            echo ""
            echo "Use CosmicPalette or GlassTokens instead."
            echo "Add '// theme-exempt' comment if intentional."
            # Warning only, not blocking
          else
            echo "✅ No hardcoded colors outside theme"
          fi

      - name: Check for hardcoded spacing
        run: |
          # Scan for EdgeInsets with raw numbers > 4
          SPACING_VIOLATIONS=$(grep -rn "EdgeInsets\.\(all\|symmetric\|only\|fromLTRB\)" lib/features/ \
            --include="*.dart" \
            | grep -E "\b(1[7-9]|[2-9][0-9]|[0-9]{3,})\b" \
            | grep -v "// spacing-exempt" \
            | grep -v "_test.dart" \
            | head -20 \
            || true)

          if [ -n "$SPACING_VIOLATIONS" ]; then
            echo "⚠️ Potential hardcoded spacing (use AppConstants.spacing*):"
            echo "$SPACING_VIOLATIONS"
          else
            echo "✅ Spacing looks consistent"
          fi
